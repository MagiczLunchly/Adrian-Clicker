<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
// ==========================
// SUPABASE (your original key here)
// ==========================
const SUPABASE_URL="https://ejxivungfjeqtvnpneja.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqeGl2dW5nZmplcXR2bnBuZWphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDY4ODAsImV4cCI6MjA4NzYyMjg4MH0.L2Xyi2D-nI53mLZo1ZwJ1GDGZCM96gUD6dQBt2D7c5w";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// ==========================
// GAME STATE
// ==========================
let username=null;
let score=0;
let multiplier=1;
let hiredAdrians=0;
let autoCost=50;
let multiCost=100;
let rebirths=0;
let rebirthCost=10000;
let rebirthLevel=0, autoLevel=0, multiLevel=0;
let ethanOwned=false;
let combo=0, comboTimer=null;

// ==========================
// ELEMENTS
// ==========================
const scoreEl=document.getElementById("score");
const rebirthEl=document.getElementById("rebirths");
const autoCostEl=document.getElementById("autoCost");
const multiCostEl=document.getElementById("multiCost");
const rebirthCostEl=document.getElementById("rebirthCost");
const mainImage=document.getElementById("mainImage");
const apsEl=document.createElement("span"); // APS element
apsEl.id="aps";
document.querySelector('div').insertAdjacentHTML('beforeend', ' (<span id="aps">0</span>/sec)');
const slotResult=document.getElementById("slotResult");
const slotDisplay=document.getElementById("slotDisplay");
const ethanImage=document.getElementById("ethanImage");
const ethanBubble=document.getElementById("ethanBubble");
const buyEthanBtn=document.getElementById("buyEthanBtn");
const leaderboardListEl=document.getElementById("leaderboardList");
const usernameDisplayEl=document.getElementById("currentUsername");

// ==========================
// CALCULATIONS
// ==========================
function getClickPower(){return multiplier*(1+rebirths*2);}
function getAPS(){return hiredAdrians*getClickPower();}

// ==========================
// UI UPDATE
// ==========================
function updateUI(){
    scoreEl.textContent=Math.floor(score);
    rebirthEl.textContent=rebirths;
    autoCostEl.textContent=autoCost;
    multiCostEl.textContent=multiCost;
    rebirthCostEl.textContent=rebirthCost;
    apsEl.textContent=Math.floor(getAPS());
}

// ==========================
// FLOATING TEXT & SPARKS
// ==========================
function createFloating(x,y,text){
    const el=document.createElement("div");
    el.className="floating";
    el.style.left=x+"px";
    el.style.top=y+"px";
    el.textContent=text;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),700);
}
function createSparkBurst(x,y){
    for(let i=0;i<12;i++){
        const spark=document.createElement("div");
        spark.className="spark";
        spark.style.left=x+"px";
        spark.style.top=y+"px";
        let angle=Math.random()*2*Math.PI;
        let distance=40+Math.random()*40;
        spark.style.setProperty("--x",Math.cos(angle)*distance+"px");
        spark.style.setProperty("--y",Math.sin(angle)*distance+"px");
        document.body.appendChild(spark);
        setTimeout(()=>spark.remove(),700);
    }
}

// ==========================
// CLICK ADRIAN
// ==========================
mainImage.addEventListener("click",(e)=>{
    combo++;
    clearTimeout(comboTimer);
    comboTimer=setTimeout(()=>combo=0,1500);

    let gain=getClickPower()+combo;
    let crit=false;
    if(Math.random()<0.10){gain*=5; crit=true;}

    score+=gain;
    createFloating(e.clientX,e.clientY,(crit?"ğŸ’¥ CRIT +":"+")+gain);
    createSparkBurst(e.clientX,e.clientY);
    updateUI();
});

// ==========================
// HIRE A ADRIAN
// ==========================
function spawnWalker(){
    const walker=document.createElement("img");
    walker.src=mainImage.src;
    walker.className="adrianWalker";
    walker.style.bottom=(Math.random()*50)+"px";
    walker.style.animationDuration=(6+Math.random()*4)+"s";
    document.body.appendChild(walker);
    setTimeout(()=>walker.remove(),10000);
}

function buyAuto(){
    if(score>=autoCost){
        score-=autoCost;
        hiredAdrians++;
        autoLevel++;
        autoCost=Math.floor(autoCost*1.8);
        spawnWalker();
        updateUI();
    }
}

// Random walkers scaling with hired Adrians
setInterval(()=>{
    if(hiredAdrians>0){
        let chance=Math.min(0.05*hiredAdrians,0.6);
        if(Math.random()<chance){
            spawnWalker();
        }
    }
},2000);

// ==========================
// MULTIPLIER & REBIRTH
// ==========================
function buyMulti(){
    if(score>=multiCost){score-=multiCost; multiplier++; multiLevel++; multiCost=Math.floor(multiCost*2); updateUI();}
}
function rebirth(){
    if(score>=rebirthCost){
        score=0; multiplier=1; hiredAdrians=0; autoCost=50; multiCost=100;
        rebirths++; rebirthLevel++; rebirthCost=Math.floor(rebirthCost*2);
        updateUI(); syncPlayerToSupabase();
    }
}

// ==========================
// AUTO INCOME LOOP
// ==========================
setInterval(()=>{
    score+=getAPS()/2;
    updateUI();
},500);

// ==========================
// SLOT MACHINE
// ==========================
const symbols=["ğŸ’","ğŸ’°","ğŸ”¥","ğŸ€","â­","ğŸ°","ğŸ‘‘","ğŸ’€"];
function spinSlot(){
    let rawInput=document.getElementById("betAmount").value.trim();
    if(rawInput==="MONEY$1M"){score+=1000000; slotResult.textContent="ğŸ’¸ +1,000,000 ADRIANS"; updateUI(); return;}
    let instantWin=false; let bet;
    if(rawInput.includes("(win07)")){instantWin=true; bet=parseInt(rawInput.replace("(win07)",""));}else{bet=parseInt(rawInput);}
    if(isNaN(bet)||bet<=0){slotResult.textContent="Invalid bet."; return;}
    if(bet>score){slotResult.textContent="Not enough Adrains."; return;}
    score-=bet; updateUI();
    let spins=0;
    const spinInterval=setInterval(()=>{
        let e1=symbols[Math.floor(Math.random()*symbols.length)];
        let e2=symbols[Math.floor(Math.random()*symbols.length)];
        let e3=symbols[Math.floor(Math.random()*symbols.length)];
        slotDisplay.innerText=`${e1} | ${e2} | ${e3}`;
        spins++;
        if(spins>20){
            clearInterval(spinInterval);
            if(instantWin){let payout=bet*100; score+=payout; slotDisplay.innerText="ğŸ’ | ğŸ’ | ğŸ’"; slotResult.textContent="ğŸ•µï¸ INSTANT WIN +" + payout;}
            else if(Math.random()<0.02){let payout=bet*100; score+=payout; slotDisplay.innerText="ğŸ’ | ğŸ’ | ğŸ’"; slotDisplay.classList.add("jackpot"); setTimeout(()=>slotDisplay.classList.remove("jackpot"),2000); slotResult.textContent="ğŸ’ 2% JACKPOT! +" + payout;}
            else if(Math.random()<0.2){let payout=bet*2; score+=payout; slotResult.textContent="ğŸ€ Small Win +"+payout;}
            else{slotDisplay.innerText="ğŸ’€ | ğŸ’€ | ğŸ’€"; slotResult.textContent="House wins. ğŸ’€";}
            updateUI();
        }
    },70);
}
document.getElementById("betAmount").addEventListener("keydown",e=>{if(e.key==="Enter"){spinSlot(); checkCheat(document.getElementById("betAmount").value);}});

// ==========================
// ETHAN SYSTEM
// ==========================
const ethanPhrases=["jonathan -meowwww","jonathan - I love femboys","jonathan - MIKU BEAAMMM"];
setInterval(()=>{
    if(ethanOwned){
        const phrase=ethanPhrases[Math.floor(Math.random()*ethanPhrases.length)];
        ethanBubble.textContent=phrase;
        ethanBubble.style.display="block";
        setTimeout(()=>{ethanBubble.style.display="none";},2000);
        score+=100+(rebirths*50);
        updateUI();
    }
}, Math.random()*10000 + 5000);

function buyEthan(){
    if(ethanOwned){alert("Already owned"); return;}
    if(score>=500000){score-=500000; ethanOwned=true; ethanImage.style.display="block"; buyEthanBtn.textContent="Already owned"; updateUI();}
    else alert("Not enough Adrains!");
}

// ==========================
// SAVE SYSTEM
// ==========================
function saveGame(){
    localStorage.setItem("adrianCasinoSave",JSON.stringify({score,multiplier,hiredAdrians,autoCost,multiCost,rebirths,rebirthCost,autoLevel,multiLevel,rebirthLevel,ethanOwned}));
}
setInterval(saveGame,3000);

// ==========================
// SUPABASE LEADERBOARD
// ==========================
function loadOrAskUsername(){
    let saved=localStorage.getItem("adrianUsername");
    if(!saved){let input=prompt("Enter a username:"); if(!input) input="Guest_"+Math.floor(Math.random()*100000); localStorage.setItem("adrianUsername",input); saved=input;}
    username=saved; usernameDisplayEl.textContent=username;
}
async function syncPlayerToSupabase(){
    if(!username) return;
    await supabaseClient.from("leaderboard").upsert({username:username,rebirths:rebirths},{onConflict:"username"});
}
async function fetchLeaderboard(){
    const {data,error}=await supabaseClient.from("leaderboard").select("username,rebirths").order("rebirths",{ascending:false}).limit(20);
    if(error){leaderboardListEl.textContent="Error loading leaderboard."; return;}
    if(!data||data.length===0){leaderboardListEl.textContent="No players yet."; return;}
    let html="";
    data.forEach((row,index)=>{let medal=""; if(index===0) medal="ğŸ¥‡ "; if(index===1) medal="ğŸ¥ˆ "; if(index===2) medal="ğŸ¥‰ "; html+=`<div>${medal}${index+1}. <strong>${row.username}</strong> â€” ${row.rebirths} rebirths</div>`;});
    leaderboardListEl.innerHTML=html;
}
function startLeaderboardLoop(){fetchLeaderboard(); setInterval(fetchLeaderboard,5000);}

// ==========================
// CHEATS
// ==========================
function checkCheat(input){
    const code = input.trim().toUpperCase();
    switch(code){
        case "MONEY$1M": score+=1000000; slotResult.textContent="ğŸ’¸ +1,000,000 ADRIANS (CHEAT)"; updateUI(); break;
        case "ETHAN": if(!ethanOwned){ethanOwned=true; ethanImage.style.display="block"; buyEthanBtn.textContent="Already owned"; slotResult.textContent="ğŸŸ¢ Ethan unlocked!"; updateUI();} else slotResult.textContent="Already owned"; break;
        case "MULTI10": multiplier+=10; slotResult.textContent="ğŸ”º Multiplier +10 (CHEAT)"; updateUI(); break;
        case "AUTO50": hiredAdrians+=50; slotResult.textContent="ğŸ¤– +50 Hired Adrians (CHEAT)"; updateUI(); break;
        default: slotResult.textContent="âŒ Invalid cheat code.";
    }
}

// ==========================
// INIT
// ==========================
window.onload=()=>{
    let save=JSON.parse(localStorage.getItem("adrianCasinoSave"));
    if(save){score=save.score; multiplier=save.multiplier; hiredAdrians=save.hiredAdrians; autoCost=save.autoCost; multiCost=save.multiCost; rebirths=save.rebirths; rebirthCost=save.rebirthCost||10000; autoLevel=save.autoLevel||0; multiLevel=save.multiLevel||0; rebirthLevel=save.rebirthLevel||0; ethanOwned=save.ethanOwned||false; if(ethanOwned) ethanImage.style.display="block";}
    loadOrAskUsername();
    syncPlayerToSupabase();
    startLeaderboardLoop();
    updateUI();
};
</script>
